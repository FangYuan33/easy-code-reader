name: Publish to PyPI

on:
  # è§¦å‘æ–¹å¼ 1: åˆ›å»ºæ–°çš„ GitHub Release æ—¶è‡ªåŠ¨å‘å¸ƒ
  release:
    types: [published]
  
  # è§¦å‘æ–¹å¼ 2: æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      test_pypi:
        description: 'å‘å¸ƒåˆ°æµ‹è¯• PyPI'
        required: false
        type: boolean
        default: false

jobs:
  build-and-publish:
    name: æž„å»ºå¹¶å‘å¸ƒ Python åŒ…
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œç”¨äºŽç‰ˆæœ¬æ ‡ç­¾
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: æ˜¾ç¤º Python ç‰ˆæœ¬
      run: |
        python --version
        pip --version
    
    - name: å®‰è£…æž„å»ºå·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
      id: get_version
      run: |
        VERSION=$(grep "^version = " pyproject.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ ç‰ˆæœ¬å·: $VERSION"
    
    - name: æ¸…ç†æ—§çš„æž„å»ºæ–‡ä»¶
      run: |
        rm -rf dist/ build/ *.egg-info src/*.egg-info
    
    - name: æž„å»ºåŒ…
      run: |
        python -m build
        echo "âœ“ æž„å»ºå®Œæˆ"
        echo "æž„å»ºçš„æ–‡ä»¶:"
        ls -lh dist/
    
    - name: æ£€æŸ¥åŒ…
      run: |
        twine check dist/*
        echo "âœ“ åŒ…æ£€æŸ¥é€šè¿‡"
    
    - name: å‘å¸ƒåˆ°æµ‹è¯• PyPI
      if: github.event.inputs.test_pypi == 'true'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        echo "ðŸ“¤ ä¸Šä¼ åˆ°æµ‹è¯• PyPI..."
        twine upload --repository testpypi dist/*
        echo "âœ“ å‘å¸ƒæˆåŠŸï¼"
        echo "ðŸ“¦ åŒ…åœ°å€: https://test.pypi.org/project/easy-jar-reader/${{ steps.get_version.outputs.version }}/"
    
    - name: å‘å¸ƒåˆ°æ­£å¼ PyPI
      if: github.event.inputs.test_pypi != 'true'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "ðŸ“¤ ä¸Šä¼ åˆ°æ­£å¼ PyPI..."
        twine upload dist/*
        echo "âœ“ å‘å¸ƒæˆåŠŸï¼ðŸŽ‰"
        echo "ðŸ“¦ åŒ…åœ°å€: https://pypi.org/project/easy-jar-reader/${{ steps.get_version.outputs.version }}/"
    
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
    
    - name: åˆ›å»ºå‘å¸ƒæ‘˜è¦
      run: |
        echo "## ðŸŽ‰ å‘å¸ƒæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ç‰ˆæœ¬:** ${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**åŒ…å:** easy-jar-reader" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.test_pypi }}" == "true" ]; then
          echo "**ä»“åº“:** æµ‹è¯• PyPI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å®‰è£…æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ easy-jar-reader" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "**ä»“åº“:** æ­£å¼ PyPI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å®‰è£…" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "pip install easy-jar-reader" >> $GITHUB_STEP_SUMMARY
          echo "# æˆ–" >> $GITHUB_STEP_SUMMARY
          echo "uvx easy-jar-reader" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
