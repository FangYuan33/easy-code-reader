name: Publish to PyPI

on:
  # è§¦å‘æ–¹å¼ 1: åˆ›å»ºæ–°çš„ GitHub Release æ—¶è‡ªåŠ¨å‘å¸ƒ
  release:
    types: [published]
  
  # è§¦å‘æ–¹å¼ 2: æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      test_pypi:
        description: 'å‘å¸ƒåˆ°æµ‹è¯• PyPI'
        required: false
        type: boolean
        default: false

jobs:
  build-and-publish:
    name: æ„å»ºå¹¶å‘å¸ƒ Python åŒ…
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PACKAGE_NAME: easy-code-reader
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç‰ˆæœ¬æ ‡ç­¾
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: æ˜¾ç¤º Python ç‰ˆæœ¬
      run: |
        python --version
        pip --version
    
    - name: å®‰è£…æ„å»ºå·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install build twine tomli
    
    - name: è·å–ç‰ˆæœ¬ä¿¡æ¯ï¼ˆä» pyproject.toml è§£æï¼‰
      id: get_version
      run: |
        python - <<'PY'
        import os
        try:
            import tomllib  # Py3.11+
        except ModuleNotFoundError:
            import tomli as tomllib  # Py3.10 fallback
        with open('pyproject.toml', 'rb') as f:
            data = tomllib.load(f)
        version = data['project']['version']
        print(f"ğŸ“¦ ç‰ˆæœ¬å·: {version}")
        with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
            fh.write(f"version={version}\n")
        PY

    - name: æ ¡éªŒ Release æ ‡ç­¾ä¸ç‰ˆæœ¬ä¸€è‡´ï¼ˆä»…åœ¨ release äº‹ä»¶ï¼‰
      if: github.event_name == 'release'
      run: |
        VERSION='${{ steps.get_version.outputs.version }}'
        if [ -n "${{ github.event.release.tag_name }}" ]; then
          TAG='${{ github.event.release.tag_name }}'
        else
          TAG='${{ github.ref_name }}'
        fi
        echo "Release tag: ${TAG}"
        if [ "v${VERSION}" != "${TAG}" ]; then
          echo "âŒ ç‰ˆæœ¬å·ä¸æ ‡ç­¾ä¸ä¸€è‡´: version=v${VERSION}, tag=${TAG}"
          exit 1
        fi
        echo "âœ“ ç‰ˆæœ¬å·ä¸æ ‡ç­¾ä¸€è‡´"
    
    - name: æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶
      run: |
        rm -rf dist/ build/ *.egg-info src/*.egg-info
    
    - name: æ„å»ºåŒ…
      run: |
        python -m build
        echo "âœ“ æ„å»ºå®Œæˆ"
        echo "æ„å»ºçš„æ–‡ä»¶:"
        ls -lh dist/
    
    - name: æ£€æŸ¥åŒ…
      run: |
        twine check dist/*
        echo "âœ“ åŒ…æ£€æŸ¥é€šè¿‡"
    
    - name: å‘å¸ƒåˆ°æµ‹è¯• PyPI
      if: github.event.inputs.test_pypi == 'true'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        echo "ğŸ“¤ ä¸Šä¼ åˆ°æµ‹è¯• PyPI..."
        twine upload --repository testpypi dist/*
        echo "âœ“ å‘å¸ƒæˆåŠŸï¼"
        echo "ğŸ“¦ åŒ…åœ°å€: https://test.pypi.org/project/${PACKAGE_NAME}/${{ steps.get_version.outputs.version }}/"
    
    - name: å‘å¸ƒåˆ°æ­£å¼ PyPI
      if: github.event.inputs.test_pypi != 'true'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "ğŸ“¤ ä¸Šä¼ åˆ°æ­£å¼ PyPI..."
        twine upload dist/*
        echo "âœ“ å‘å¸ƒæˆåŠŸï¼ğŸ‰"
        echo "ğŸ“¦ åŒ…åœ°å€: https://pypi.org/project/${PACKAGE_NAME}/${{ steps.get_version.outputs.version }}/"
    
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
    
    - name: åˆ›å»ºå‘å¸ƒæ‘˜è¦
      run: |
        echo "## ğŸ‰ å‘å¸ƒæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ç‰ˆæœ¬:** ${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**åŒ…å:** ${PACKAGE_NAME}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.test_pypi }}" == "true" ]; then
          echo "**ä»“åº“:** æµ‹è¯• PyPI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å®‰è£…æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ ${PACKAGE_NAME}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "**ä»“åº“:** æ­£å¼ PyPI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å®‰è£…" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "pip install ${PACKAGE_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "# æˆ–" >> $GITHUB_STEP_SUMMARY
          echo "uvx ${PACKAGE_NAME}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
